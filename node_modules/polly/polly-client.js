var polly = {

	init: function(registerUrl, holdUrl, pushUrl, partUrl eventHandler) {
		polly.registerUrl = registerUrl;
		polly.holdUrl = holdUrl;
		polly.eventHandler = eventHandler;	
		polly.pushUrl = pushUrl;
		polly.partUrl = partUrl;
		polly.lastEventId = -1;
	},

	register: function(data, cb) {
		$.getJSON(polly.registerUrl, data,function(data) {
			if(data.status) {
				polly.hold();
				cb(data);
			}
		}); 
	},
	
	hold: function() {
		$.getJSON(polly.holdUrl, {
			lastEventId: polly.lastEventId
		}, function(data) {
			if(data.status) {
				var events = data.events;
				if(events && events.length > 0)
					polly.lastEventId = events[events.length-1].id;
				polly.hold();
				for(i in events) {
					var event = events[i];
					var handler = polly.eventHandler[event.type];
					if(handler && typeof handler == "function") {
						handler(event);
					}
				}
			}
		});
	},
	
	pushEvent: function(eventType, data) {
		data.eventType = eventType;
		$.getJSON(polly.pushUrl, data);
	},
	
	part: function(cb) {
		$.getJSON(polly.partUrl, function(data) {
			if(data.status) {
				cb();
			}
		}); 
	}

}
